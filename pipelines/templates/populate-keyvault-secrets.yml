# ============================================
# POPULATE KEY VAULT SECRETS TEMPLATE
# ============================================
# This template populates Azure Key Vault with secrets after Terraform creates the infrastructure.
# Secrets come from Azure DevOps Variable Groups and are set directly via Azure CLI.

parameters:
- name: environment
  type: string
- name: azureServiceConnection
  type: string
- name: keyVaultName
  type: string

steps:
- task: AzureCLI@2
  displayName: 'Populate Key Vault Secrets - ${{ parameters.environment }}'
  inputs:
    azureSubscription: '${{ parameters.azureServiceConnection }}'
    scriptType: 'bash'
    scriptLocation: 'scriptPath'
    scriptPath: '$(System.DefaultWorkingDirectory)/infrastructure/scripts/populate-keyvault-secrets.sh'
    arguments: '${{ parameters.environment }} ${{ parameters.keyVaultName }}'
  env:
    # Map Variable Group variables to environment variables
    # These should be defined in your Variable Groups (keyvault-secrets-dev/test/prod)
    DATABASE_CONNECTION_STRING: $(DATABASE_CONNECTION_STRING)
    EXTERNAL_API_KEY: $(EXTERNAL_API_KEY)
    STORAGE_ACCOUNT_KEY: $(STORAGE_ACCOUNT_KEY)
    APPINSIGHTS_INSTRUMENTATION_KEY: $(APPINSIGHTS_INSTRUMENTATION_KEY)
    # Add more secret mappings as needed
