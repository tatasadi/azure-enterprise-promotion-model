# ============================================
# ENTERPRISE AZURE DEVOPS PIPELINE
# ============================================
# This pipeline demonstrates modern DevOps practices:
# - Build once, deploy many (artifact promotion)
# - Infrastructure as Code with Terraform
# - Multi-environment deployment (dev → test → prod)
# - Approval gates between environments
# - Modular, reusable templates

trigger:
  branches:
    include:
    - main
  paths:
    exclude:
    - docs/*
    - README.md

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  dotnetVersion: '9.0.x'

stages:
# ============================================
# BUILD STAGE - Build Once
# ============================================
- stage: Build
  displayName: 'Build Application'
  jobs:
  - job: BuildJob
    displayName: 'Build .NET Application'
    steps:
    - template: pipelines/templates/build.yml
      parameters:
        buildConfiguration: $(buildConfiguration)
        dotnetVersion: $(dotnetVersion)
        projectPath: 'src/InventoryApi/InventoryApi.csproj'

# ============================================
# DEV ENVIRONMENT
# ============================================
- stage: Dev
  displayName: 'Dev - Infrastructure & Deployment'
  dependsOn: Build
  variables:
  - group: keyvault-secrets-dev  # Variable Group containing secrets for Key Vault (used after Terraform)
  jobs:
  - deployment: DeployDev
    displayName: 'Deploy Dev Infrastructure & Application'
    environment: 'dev'
    strategy:
      runOnce:
        deploy:
          steps:
          # Provision Infrastructure
          - template: pipelines/templates/terraform-plan.yml
            parameters:
              environment: 'dev'
              azureServiceConnection: 'Azure-ServiceConnection-Dev'
              workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/environments/dev'

          - template: pipelines/templates/terraform-apply.yml
            parameters:
              environment: 'dev'
              azureServiceConnection: 'Azure-ServiceConnection-Dev'
              workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/environments/dev'

          - template: pipelines/templates/populate-keyvault-secrets.yml
            parameters:
              environment: 'dev'
              azureServiceConnection: 'Azure-ServiceConnection-Dev'
              keyVaultName: 'kv-inventory-dev-001'

          # Deploy Application
          - template: pipelines/templates/deploy-app.yml
            parameters:
              environment: 'dev'
              azureServiceConnection: 'Azure-ServiceConnection-Dev'
              appServiceName: 'app-inventory-dev-001'

# ============================================
# TEST ENVIRONMENT (with approval gate)
# ============================================
- stage: Test
  displayName: 'Test - Infrastructure & Deployment'
  dependsOn: Dev
  variables:
  - group: keyvault-secrets-test  # Variable Group containing secrets for Key Vault (used after Terraform)
  jobs:
  - deployment: DeployTest
    displayName: 'Deploy Test Infrastructure & Application'
    environment: 'test'  # Single approval gate for entire Test environment
    strategy:
      runOnce:
        deploy:
          steps:
          # Provision Infrastructure
          - template: pipelines/templates/terraform-plan.yml
            parameters:
              environment: 'test'
              azureServiceConnection: 'Azure-ServiceConnection-Test'
              workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/environments/test'

          - template: pipelines/templates/terraform-apply.yml
            parameters:
              environment: 'test'
              azureServiceConnection: 'Azure-ServiceConnection-Test'
              workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/environments/test'

          - template: pipelines/templates/populate-keyvault-secrets.yml
            parameters:
              environment: 'test'
              azureServiceConnection: 'Azure-ServiceConnection-Test'
              keyVaultName: 'kv-inventory-test-001'

          # Deploy Application
          - template: pipelines/templates/deploy-app.yml
            parameters:
              environment: 'test'
              azureServiceConnection: 'Azure-ServiceConnection-Test'
              appServiceName: 'app-inventory-test-001'

# ============================================
# PROD ENVIRONMENT (with approval gate)
# ============================================
- stage: Prod
  displayName: 'Prod - Infrastructure & Deployment'
  dependsOn: Test
  variables:
  - group: keyvault-secrets-prod  # Variable Group containing secrets for Key Vault (used after Terraform)
  jobs:
  - deployment: DeployProd
    displayName: 'Deploy Prod Infrastructure & Application'
    environment: 'prod'  # Single approval gate for entire Prod environment
    strategy:
      runOnce:
        deploy:
          steps:
          # Provision Infrastructure
          - template: pipelines/templates/terraform-plan.yml
            parameters:
              environment: 'prod'
              azureServiceConnection: 'Azure-ServiceConnection-Prod'
              workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/environments/prod'

          - template: pipelines/templates/terraform-apply.yml
            parameters:
              environment: 'prod'
              azureServiceConnection: 'Azure-ServiceConnection-Prod'
              workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/environments/prod'

          - template: pipelines/templates/populate-keyvault-secrets.yml
            parameters:
              environment: 'prod'
              azureServiceConnection: 'Azure-ServiceConnection-Prod'
              keyVaultName: 'kv-inventory-prod-001'

          # Deploy Application
          - template: pipelines/templates/deploy-app.yml
            parameters:
              environment: 'prod'
              azureServiceConnection: 'Azure-ServiceConnection-Prod'
              appServiceName: 'app-inventory-prod-001'

          - script: |
              echo "================================================"
              echo "Production Deployment Complete!"
              echo "App URL: https://app-inventory-prod-001.azurewebsites.net"
              echo "Build Number: $(Build.BuildNumber)"
              echo "================================================"
            displayName: 'Deployment Summary'
