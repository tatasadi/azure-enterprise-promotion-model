# ============================================
# ENTERPRISE AZURE DEVOPS PIPELINE
# ============================================
# This pipeline demonstrates modern DevOps practices:
# - Build once, deploy many (artifact promotion)
# - Infrastructure as Code with Terraform
# - Multi-environment deployment (dev → test → prod)
# - Approval gates between environments
# - Modular, reusable templates

trigger:
  branches:
    include:
    - main
  paths:
    exclude:
    - docs/*
    - README.md
    - plan.md

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  dotnetVersion: '9.0.x'

stages:
# ============================================
# BUILD STAGE - Build Once
# ============================================
- stage: Build
  displayName: 'Build Application'
  jobs:
  - job: BuildJob
    displayName: 'Build .NET Application'
    steps:
    - template: pipelines/templates/build.yml
      parameters:
        buildConfiguration: $(buildConfiguration)
        dotnetVersion: $(dotnetVersion)
        projectPath: 'src/InventoryApi/InventoryApi.csproj'

# ============================================
# DEV ENVIRONMENT
# ============================================
- stage: Dev_Infrastructure
  displayName: 'Dev - Infrastructure'
  dependsOn: Build
  variables:
  - group: keyvault-secrets-dev  # Variable Group containing secrets for Key Vault (used after Terraform)
  jobs:
  - job: TerraformPlan
    displayName: 'Terraform Plan'
    steps:
    - template: pipelines/templates/terraform-plan.yml
      parameters:
        environment: 'dev'
        azureServiceConnection: 'Azure-ServiceConnection-Dev'
        workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/environments/dev'

  - job: TerraformApply
    displayName: 'Terraform Apply'
    dependsOn: TerraformPlan
    steps:
    - template: pipelines/templates/terraform-apply.yml
      parameters:
        environment: 'dev'
        azureServiceConnection: 'Azure-ServiceConnection-Dev'
        workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/environments/dev'

    - template: pipelines/templates/populate-keyvault-secrets.yml
      parameters:
        environment: 'dev'
        azureServiceConnection: 'Azure-ServiceConnection-Dev'
        keyVaultName: 'kv-inventory-dev-001'

- stage: Dev_Deploy
  displayName: 'Dev - Deploy Application'
  dependsOn: Dev_Infrastructure
  jobs:
  - deployment: DeployDev
    displayName: 'Deploy to Dev'
    environment: 'dev'
    strategy:
      runOnce:
        deploy:
          steps:
          - template: pipelines/templates/deploy-app.yml
            parameters:
              environment: 'dev'
              azureServiceConnection: 'Azure-ServiceConnection-Dev'
              appServiceName: 'app-inventory-dev-001'

# ============================================
# TEST ENVIRONMENT (with approval gate)
# ============================================
- stage: Test_Infrastructure
  displayName: 'Test - Infrastructure'
  dependsOn: Dev_Deploy
  variables:
  - group: keyvault-secrets-test  # Variable Group containing secrets for Key Vault (used after Terraform)
  jobs:
  - job: TerraformPlan
    displayName: 'Terraform Plan'
    steps:
    - template: pipelines/templates/terraform-plan.yml
      parameters:
        environment: 'test'
        azureServiceConnection: 'Azure-ServiceConnection-Test'
        workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/environments/test'

  - job: TerraformApply
    displayName: 'Terraform Apply'
    dependsOn: TerraformPlan
    steps:
    - template: pipelines/templates/terraform-apply.yml
      parameters:
        environment: 'test'
        azureServiceConnection: 'Azure-ServiceConnection-Test'
        workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/environments/test'

    - template: pipelines/templates/populate-keyvault-secrets.yml
      parameters:
        environment: 'test'
        azureServiceConnection: 'Azure-ServiceConnection-Test'
        keyVaultName: 'kv-inventory-test-001'

- stage: Test_Deploy
  displayName: 'Test - Deploy Application'
  dependsOn: Test_Infrastructure
  jobs:
  - deployment: DeployTest
    displayName: 'Deploy to Test'
    environment: 'test'  # Environment with approval gate configured in Azure DevOps
    strategy:
      runOnce:
        deploy:
          steps:
          - template: pipelines/templates/deploy-app.yml
            parameters:
              environment: 'test'
              azureServiceConnection: 'Azure-ServiceConnection-Test'
              appServiceName: 'app-inventory-test-001'

# ============================================
# PROD ENVIRONMENT (with approval gate)
# ============================================
- stage: Prod_Infrastructure
  displayName: 'Prod - Infrastructure'
  dependsOn: Test_Deploy
  variables:
  - group: keyvault-secrets-prod  # Variable Group containing secrets for Key Vault (used after Terraform)
  jobs:
  - job: TerraformPlan
    displayName: 'Terraform Plan'
    steps:
    - template: pipelines/templates/terraform-plan.yml
      parameters:
        environment: 'prod'
        azureServiceConnection: 'Azure-ServiceConnection-Prod'
        workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/environments/prod'

  - job: TerraformApply
    displayName: 'Terraform Apply'
    dependsOn: TerraformPlan
    steps:
    - template: pipelines/templates/terraform-apply.yml
      parameters:
        environment: 'prod'
        azureServiceConnection: 'Azure-ServiceConnection-Prod'
        workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/environments/prod'

    - template: pipelines/templates/populate-keyvault-secrets.yml
      parameters:
        environment: 'prod'
        azureServiceConnection: 'Azure-ServiceConnection-Prod'
        keyVaultName: 'kv-inventory-prod-001'

- stage: Prod_Deploy
  displayName: 'Prod - Deploy Application'
  dependsOn: Prod_Infrastructure
  jobs:
  - deployment: DeployProd
    displayName: 'Deploy to Production'
    environment: 'prod'  # Environment with approval gate configured in Azure DevOps
    strategy:
      runOnce:
        deploy:
          steps:
          - template: pipelines/templates/deploy-app.yml
            parameters:
              environment: 'prod'
              azureServiceConnection: 'Azure-ServiceConnection-Prod'
              appServiceName: 'app-inventory-prod-001'

          - script: |
              echo "================================================"
              echo "Production Deployment Complete!"
              echo "App URL: https://app-inventory-prod-001.azurewebsites.net"
              echo "Build Number: $(Build.BuildNumber)"
              echo "================================================"
            displayName: 'Deployment Summary'
